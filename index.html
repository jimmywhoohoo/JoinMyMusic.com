<head>
    <title>ssamjh's Music Sync</title>
    <script type="text/javascript" src="//code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="//pages.github.com/css/pages.css" type="text/css">
    <link rel="stylesheet" href="css/buttons.css">
</head>

<body>
    <center>
        <h2>ssamjh's Music Sync</h2>
        <h3>joinmymusic.com</h3>
        <br>
        <audio id="audio-stream" preload="auto"></audio>
        <br>
        <a>
            <b>Stream Quality:</b>
        </a>
        <select name="select-quality" id="select-quality" onchange="qualityUpdate(this.value);cookieSet('quality', this.value, 365);">
        <option value="audiophile" title="You are so cool that you need your own water supply.&#13;&#10;&#13;&#10;16bit FLAC">Audiophile</option>
        <option value="high" selected="selected" title="For those premium people that enjoy premium audio.&#13;&#10;&#13;&#10;256Kbps Opus">High</option>
        <option value="normal" title="Smack-bang in the middle. Perfect for the normies.&#13;&#10;&#13;&#10;128Kbps Opus">Normal</option>
        <option value="low" title="Do you struggle with internet? This stream will literally work on dialup.&#13;&#10;&#13;&#10;32Kbps HE-AAC">Low</option>
      </select>
        <br>
        <br>
        <button class="small button" id="button-toggle" onclick="buttonPlay();">Play</button>
        <br>
        <br>
        <br>
        <div id="div-volume">
            <br>
            <a>
                <b>Volume: </b>
            </a>
            <label class="volume-percentage" for="volume-percentage"></label>
            <br>
            <input id="input-volume" type="range" min="0" max="100" step="0.1" value="0" class="input-volume" oninput="volumeSet(this.value);cookieSet('volume', this.value, 365);" onchange="volumeSet(this.value);cookieSet('volume', this.value, 365);"></input>
        </div>
        <br>
        <a>
            <b>Now Playing: </b>
        </a>
        <h4 style="font-size:16">
            <div class="div-playing-title"></div>
        </h4>
        <h4 style="font-size:12">
            <div class="div-playing-artist"></div>
        </h4>
        <br>
        <div class="div-playing-image">
            <a id="playing-link" target="_blank">
                <img id="playing-image" class="playing-image" alt="Now playing image" width="200" height="200">
            </a>
        </div>
        <br>
    </center>
    <footer class="page-footer">
        <ul class="site-footer-links right">
            <li>
                <a href="https://ssamjh.nz/">Primary Website</a>
            </li>
        </ul>
        <a href="https://github.com/ssamjh/Music-Sync-Web">
            <span class="mega-octicon octicon-mark-github"></span>
        </a>
        <ul class="site-footer-links">
            <li>Â© 2022 <span>ssamjh</span>
            </li>
        </ul>
    </footer>
    <script type="text/javascript">
        function cookieSet(cname, cvalue, exdays) {
            const d = new Date();
            d.setTime(d.getTime() + (exdays * 24 * 60 * 60 * 1000));
            let expires = "expires=" + d.toUTCString();
            document.cookie = cname + "=" + cvalue + ";" + expires + ";path=/";
        }

        function cookieGet(cname) {
            let name = cname + "=";
            let ca = document.cookie.split(';');
            for (let i = 0; i < ca.length; i++) {
                let c = ca[i];
                while (c.charAt(0) == ' ') {
                    c = c.substring(1);
                }
                if (c.indexOf(name) == 0) {
                    return c.substring(name.length, c.length);
                }
            }
            return "";
        }
        window.onload = function() {
            // Hide the stop button
            var qualityCookie = cookieGet('quality');
            if (qualityCookie != "") {
                qualityUpdate(qualityCookie);
                document.getElementById("select-quality").value = (qualityCookie);
            } else {
                qualitySet('//icecast.sjh.at/spotifynet-hq');
            }
            if (navigator.userAgent.toLowerCase().match(/mobile/i)) {
                // Detected mobile, setting volume to 100% and removing volume bar
                console.log('Detected mobile, removing volume bar');
                document.getElementById('audio-stream').volume = 1.0;
                document.getElementById('div-volume').remove();
            } else {
                // Detected desktop, setting volume to 10%
                let volumeCookie = cookieGet('volume');
                if (volumeCookie != "") {
                    document.getElementById('audio-stream').volume = (volumeCookie / 100);
                    document.querySelector(".volume-percentage").textContent = (volumeCookie) + '%';
                    document.getElementById('input-volume').value = (volumeCookie);
                } else {
                    document.getElementById('audio-stream').volume = 0.1;
                    document.querySelector(".volume-percentage").textContent = 10 + '%';
                    document.getElementById('input-volume').value = 10;
                }
            }
        }
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.body.style.backgroundColor = "#222";
            document.body.style.color = "gray";
            console.log('Detected device in dark mode, turning off the lights!');
        }
    </script>
    <script type="text/javascript">
        function qualitySet(source) {
            document.getElementById('audio-stream').setAttribute('src', source);
            console.log('Set source to: ' + source);
        }

        function qualityUpdate(qual) {
            var audioStream = document.getElementById('audio-stream');
            if (qual == "audiophile") {
                if (audioStream.duration > 0 && !audioStream.paused) {
                    qualitySet('//icecast.sjh.at/spotifynet-uhq');
                    buttonPlay();
                } else {
                    qualitySet('//icecast.sjh.at/spotifynet-uhq');
                }
            } else if (qual == "high") {
                if (audioStream.duration > 0 && !audioStream.paused) {
                    qualitySet('//icecast.sjh.at/spotifynet-hq');
                    buttonPlay();
                } else {
                    qualitySet('//icecast.sjh.at/spotifynet-hq');
                }
            } else if (qual == "normal") {
                if (audioStream.duration > 0 && !audioStream.paused) {
                    qualitySet('//icecast.sjh.at/spotifynet');
                    buttonPlay();
                } else {
                    qualitySet('//icecast.sjh.at/spotifynet');
                }
            } else if (qual == "low") {
                if (audioStream.duration > 0 && !audioStream.paused) {
                    qualitySet('//icecast.sjh.at/spotifynet-lq');
                    buttonPlay();
                } else {
                    qualitySet('//icecast.sjh.at/spotifynet-lq');
                }
            }
        }
    </script>
    <script type="text/javascript">
        function buttonPlay() {
            document.getElementById("audio-stream").load();
            document.getElementById("audio-stream").play();
            document.getElementById('button-toggle').textContent = "Stop";
            document.getElementById('button-toggle').setAttribute("onClick", "javascript: buttonStop();");
        }

        function buttonStop() {
            document.getElementById('audio-stream').pause();
            document.getElementById('button-toggle').textContent = "Play";
            document.getElementById('button-toggle').setAttribute("onClick", "javascript: buttonPlay();");
        }
    </script>
    <script type="text/javascript">
        function volumeSet(val) {
            var player = document.getElementById('audio-stream');
            player.volume = val / 100;
        }
        document.querySelector("#input-volume").addEventListener("input", function(e) {
            document.querySelector(".volume-percentage").textContent = e.currentTarget.value + '%';
            console.log('Volume changed: ' + e.currentTarget.value + '%');
        })
    </script>
    <script type="text/javascript">
        function trackMeta() {
            console.log('Refreshing metadata');
            $.get('//joinmymusic.com/nowplaying/Snip_Artist.txt?rand=' + Math.random(), function(data) {
                $(".div-playing-artist").text(data);
            });
            $.get('//joinmymusic.com/nowplaying/Snip_Track.txt?rand=' + Math.random(), function(data) {
                $(".div-playing-title").text(data);
            });
            var myImageElement = document.getElementById('playing-image');
            myImageElement.src = '//joinmymusic.com/nowplaying/Snip_Artwork.jpg?rand=' + Math.random();
            fetch('//joinmymusic.com/nowplaying/Snip_Trackid.txt').then(response => response.text()).then((data) => {
                var spotifySongID = (data)
                if (spotifySongID != "") {
                    document.getElementById("playing-link").setAttribute("href", "https://open.spotify.com/track/" + spotifySongID)
                    document.getElementById("playing-link").setAttribute("target", "_blank");
                } else {
                    document.getElementById("playing-link").setAttribute("href", "javascript:void(0)")
                    document.getElementById("playing-link").setAttribute("target", "_self");
                }
            })
        }
        trackMeta()
        setInterval(trackMeta, 5000);
    </script>
    <script type="text/javascript">
        const pressed = [];
        const secretCode = 'ocdmode';

        window.addEventListener('keyup', (e) => {
            pressed.push(e.key);
            pressed.splice(-secretCode.length - 1, pressed.length - secretCode.length);
            if (pressed.join('').includes(secretCode)) {
                document.getElementById('input-volume').step = '1.0';
                console.log("OCD mode activated")
            }
        });
    </script>
</body>